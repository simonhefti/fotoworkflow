<!DOCTYPE html>
<html lang="en">
<head>
<title>Foto Selector</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-glyphicons.css" rel="stylesheet">

<script src="js/zepto.min.js"></script>
<script src="js/data.js"></script>
<script src="js/selector.js"></script>
<script>
window.jQuery = Zepto;
</script>
<script src="js/jsOAuth.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jwerty.js"></script>

<style type="text/css">
.h300
{
    height: 360px;
}
.r90
{
    -moz-transform:rotate(90deg);
    -webkit-transform:rotate(90deg);
}
.r180
{
    -moz-transform:rotate(180deg);
    -webkit-transform:rotate(180deg);
}
.r270
{
    -moz-transform:rotate(270deg);
    -webkit-transform:rotate(270deg);
}
.w60 {
	width: 60%;
}
#query {
	width: 30%;
}
.alert {
	padding: 5px 35px 5px 5px;
}

</style>

</head>

<body>

<div class="form-inline">
	<input id="query" type="text" class="form-control input-xlarge search-query">
	<a id="Prev1" class="btn btn-primary btn-small" href="#"><span class="glyphicon glyphicon-step-backward"></span></a>  
	<a id="Prev" class="btn btn-primary btn-small" href="#"><span class="glyphicon glyphicon-circle-arrow-left"></span></a>
	<a id="Next" class="btn btn-primary btn-small" href="#"><span class="glyphicon glyphicon-circle-arrow-right"></span></a>
	<a id='doc-all' class='btn btn-primary btn-small' href="#"><span class="glyphicon glyphicon-thumbs-down"></span></a>

	<div class="btn-group">
		<a class="btn btn-primary btn-small dropdown-toggle" data-toggle="dropdown" href="#">
			<span class="glyphicon glyphicon-wrench"></span>
    		<span class="caret"></span>
  		</a>
  		<ul class="dropdown-menu">
    		<li><a href="?cmd=evernote-oauth"><i class="icon-ok-circle"></i> Authorize with Evernote</a></li>
	    	<li><a id="menuImport" href="#"> Import Photos</a></li>
	    	<li><a id="ping" href="#"> Ping</a></li>
	    	<li><a id="grid2_4" href="#"> 2 &times; 4</a></li>
	    	<li><a id="grid1_1" href="#"> 1 &times; 1</a></li>
		</ul>
	</div>
	<div id="msgbox"></div>
</div>

<div id="output" ></div>

<div id="modalImport" class="modal fade" id="myModal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">Import photos</h4>
        	</div>
        	<div class="modal-body">
        	
	<form class="form-horizontal">
	  <div class="form-group">
	    <label class="col-lg-2 control-label" for="importPath">Path</label>
	    <div class="col-lg-10">
	      <input type="text" id="importPath" class="form-control" placeholder="Where to import your photos from (path)">
	    </div>
	  </div>
	  <div class="form-group">
	    <label class="col-lg-2 control-label" for="importPattern">Pattern</label>
	    <div class="col-lg-10">
	      <input type="text" id="importPattern" class="form-control" placeholder="/@{CreationDate: yyyy}/@{Model}/@{CreationDate: yyyy-MM}/@{CreationDate: yyyy-MM-dd'T'HHmm}_@{Filename}@{Unique}.@{Extension}">
	    </div>
	  </div>
	  <div class="form-group">
	    <label class="col-lg-2 control-label" for="importNote">Note</label>
	    <div class="col-lg-10">
	      <input type="text" id="importNote" class="form-control" placeholder="set this note for each photo">
	    </div>
	  </div>
	</form>

        	
	        </div>
    	    <div class="modal-footer">
        		<a id="importStart" href="#" class="btn btn-primary">Start import</a>
        	</div>
    	</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->


<div id="myModal" class="lightbox hide fade"  tabindex="-1" role="dialog" aria-hidden="true" width="600px">
	<div class='lightbox-header'>
		<button type="button" class="close" data-dismiss="lightbox" aria-hidden="true">&times;</button>
	</div>
	<div class='lightbox-content'>
	  <img id="overlay_img" />
	</div>
</div>



<script>

var page = 1;
var img_on_page = 0;
var cols = 4;
var rows = 2;

var _notes = [];
var _lastNote = 0;

var _showNote = function() {
	var now = new Date();
	var diff = now - _lastNote; 
	console.log("_showNote: " + now + " " + diff + " len: " + _notes.length);
	if( _notes.length > 0) {
		if( diff < 1000) {
			// console.log("_showNote: diff too small - setting new timeout");
			setTimeout(_showNote,2000);
		}
		else {
			var n = _notes.shift();
			// console.log("_showNote: new note: %s",n.text);
			var style = 'alert-success';
			if( "info" == n.code) {
				style = 'alert-info';
			}
			if( "error" == n.code) {
				style = 'alert-error';
			}
			$('#msgbox').html('<div class="alert ' + style + '"><a class="close" data-dismiss="alert">&times;</a><span>'+n.text+'</span></div>');
			_lastNote = now;
			if( _notes.length > 0) {
				// console.log("_showNote: have more notes, setting new timeout");
				setTimeout(_showNote,2000);
			}
		}
	}
}	
var _note = function(code, text) {
	// console.log("_note: " + code + " " + text);
	if( undefined == code || undefined == text) {
		return;
	}
	var n = {};
	n.code = code;
	n.text = text;
	_notes.push(n);
	_showNote();
}

var _rotate = function rotate(el, ang, parent) {
	var w = el.attr("width");
	el.animate({rotateZ:ang, translate3d: '0,10px,0'},200,'ease-out');
	parent.attr("height",w + 20);
}

var _save = function(path, k, v) {
	var url = "/?cmd=store&path=" + path + "&k=" + k + "&v="+v;
	// console.log("saving %s for %s of %s", v, k, path);
	$.get(url, function(response){
		_note("info", "saved " + v + " for " + path);
	});
}

var _readImportPattern = function() {
	var url = "/?cmd=cfg.get&k=importPattern";
	$.getJSON(url, function(r){
		$("#importPattern").val(r.payload.importPattern);
	});
}
var _setRotation = function setRotation(path, angle, img) {
	_save(path, "orientation", angle);
	var url = "/?cmd=invalidate_thumbnail&path=" + path;
	$.ajax({
		  type: 'GET',
		  url: url,
		  async: false,
		  success: function(response){
			  _note("info", "thumbnail invalidated for " + path);
			  // console.log("save result: " + response);
		  },
	});	
	var now = new Date().getTime();
	url = "/?cmd=thumbnail&t=" + now + "&path=" + path;
	img.attr("src",url);
}

var _qualificationButton = function(item, iconName, category) {
	var bDoc = $("<a class='btn btn-primary btn-mini' href='#'></a>");
	var icn = $("<span class='glyphicon glyphicon-" + iconName + "' title='" + category + "'></span>");
	bDoc.append(icn);
	if( category == item.category) {
		bDoc.removeClass("btn-primary");
		bDoc.addClass("btn-default");
	}
	bDoc.on('click', function(e) {
		_save(item.path,"category", category);
		bDoc.removeClass("btn-primary");
		bDoc.addClass("btn-default");
	});
	return bDoc;
}

var _evernote_link = function(item) {
	var bDoc = $("<a class='btn btn-primary btn-mini' href='#'></a>");
	var icn = $("<span class='glyphicon glyphicon-magnet' title='Evernote Sync'></span>");
	bDoc.append(icn);
	if( undefined != item.noteId && item.noteId.length > 1) {
		bDoc.removeClass("btn-primary");
		bDoc.addClass("btn-default");
	}
	bDoc.on('click', function(e) {
		var url = "/?cmd=evernote-link&path=" + item.path;
		$.getJSON(url, function(response){
			// console.log("evernote-link result: %o", response);
			_note(response.code, response.msg);
		});
		bDoc.removeClass("btn-primary");
		bDoc.addClass("btn-default");
	});
	return bDoc;
}

var searchFoto = function searchFoto() {
	var n = rows * cols;
	var url = "/?cmd=list&st=" + $('#query').val() + "&p="+page+"&n="+n;
	console.log("search: url: " + url);
	$.getJSON(url,function(data){
		var twitterList = $( "<div class='row'/>" );
		$( "#output" ).empty();
		if( "ok" != data.code) {
			_note(data.code, data.msg);
		}
		$.each( data.payload, function( index, item ) {
			var tr = $( "<div class='col-lg-3'/>" );
			if( 1 == cols ) {
				tr = $( "<div class='col-lg-12'/>" );
			}
			tr.data('path',item.path);
			
			var td = $("<div class='h300 thumbnail' />");
			if( 1 == cols ) {
				td = $("<div class='thumbnail' />");
			}
			tr.append(td);

			var img = $("<img src='" + item.thumbnail + "' title='" + item.path + "'>");
			if( 1 == cols ) {
				img = $("<img src='" + item.scaled_to_screen + + "' title='" + item.path + "'>");
			}
			td.append(img);
			// console.log("foto:", item.thumbnail);

			var ip = $("<input class='form-control w60' />", { type:"text" })
			if (typeof(item.note) != "undefined" && item.note.length > 0) {
				ip.val(item.note);
			}
			ip.bind('change', function() { 
			    var f = $(this) // get the current value of the input field.
				_save(item.path, "note", f.val());
			});
			td.append(ip);

			var commands = $("<p />");
			td.append(commands);
			
			var b090 = $("<button class='btn btn-info btn-mini' type='button'>R</button>");
			b090.on('click', function(e) {
				_setRotation(item.path, "90 CW", img);
			});
			commands.append(b090);
			
			var b270 = $("<button class='btn btn-info btn-mini' type='button'>L</button>");
			b270.on('click', function(e) {
				_setRotation(item.path, "270 CW", img);
			});
			commands.append(b270);
			
			var bNone = $("<button class='btn btn-info btn-mini' type='button'>NR</button>");
			bNone.on('click', function(e) {
				_rotate(img,"0deg", img);
				_save(item.path,"orientation", "rotation reset");
			});
			commands.append(bNone);
			
			// -- qualifications --
			
			var bDoc = _qualificationButton(item, 'thumbs-down', 'documentary');
			commands.append(bDoc);
			
			var bDoc = _qualificationButton(item, 'star-empty', 'normal');
			commands.append(bDoc);

			var bDoc = _qualificationButton(item, 'thumbs-up', 'selection');
			commands.append(bDoc);

			var bDoc = _qualificationButton(item, 'star', 'best-of');
			commands.append(bDoc);
			
			// evernote
			var bDoc = _evernote_link(item);
			commands.append(bDoc);

			twitterList.append(tr);
		});
		$( "#output" ).append( twitterList );
	});
}

var elem = $('#search');
elem.on('click', function(e) {
	page = 1;
	searchFoto();
});

$('#query').bind('change', function() { 
	page = 1;
	searchFoto();
});

$('#query').bind('keyup', function (e) {
  if (e.keyCode == 13) {
		page = 1;
		searchFoto();
    }
});

var elem = $('#Next');
elem.on('click', function(e) {
	page++;
	searchFoto();
});

var elem = $('#Prev');
elem.on('click', function(e) {
	page--;
	searchFoto();
});

var elem = $('#Page1');
elem.on('click', function(e) {
	page = 1;
	searchFoto();
});

var elem = $('#Page10');
elem.on('click', function(e) {
	page = 10;
	searchFoto();
});

var elem = $('#Page20');
elem.on('click', function(e) {
	page = 20;
	searchFoto();
});

$('#doc-all').on('click', function(e) {
  $('#output div div').each(function(index) {
	  var v = $(this);
	  var f = v.data('path');
	  _save(f,"category", "documentary");
  });  
});


var _readMessageState = 1;

function _readNextMessage() {
	var url = "/?cmd=msg.next";
	$.getJSON(url, function(r){
		// console.log("_readNextMessage: " + r);
		_note("info", r.msg);
	});
	if( 1 == _readMessageState) {
		setTimeout(_readNextMessage,1000);
	}
}

$('#ping').on('click', function(e) {
	var url = "/?cmd=ping";
	_readMessageState = 1;
	_readNextMessage();
	$.getJSON(url, function(r){
		_note(r.code, r.msg);
	});
	_readMessageState = 0;
});

$('#menuImport').on('click', function(e) {
	$('#modalImport').modal();
});

function updatePHashs() {
	var url = "/?cmd=update-phashs";
	$.getJSON(url, function(r){
		_note(r.code, r.msg);
	});
}

$('#importStart').on('click', function(e) {
	var url = "/?cmd=import&path=" + $('#importPath').val() + "&pattern=" + $('#importPattern').val() + "&note=" + $('#importNote').val();
	_readMessageState = 1;
	_readNextMessage();
	$('#modalImport').modal('hide');
	$.getJSON(url, function(r){
		_note(r.code, r.msg);
		updatePHashs();
	});
	_readMessageState = 0;
});

function setRowsCols(r, c) {
	rows = r;
	cols = c;
	console.log("rows: %d, cols: %d", rows, cols);
	searchFoto();
}

$('#grid2_4').on('click', function(e) {
	setRowsCols(2,4);
});

$('#grid1_1').on('click', function(e) {
	setRowsCols(1,1);
});

jwerty.key('shift+1', function () { 
	setRowsCols(1,1);
}, this, "body");

jwerty.key('shift+4', function () { 
	setRowsCols(2,4);
}, this, "body");

jwerty.key('shift+→', function () { 
	page++;
	searchFoto();
}, this, "body");

jwerty.key('shift+ctrl+→', function () {
	img_on_page++;
	if( img_on_page > 5) {
		img_on_page = 0;
	}
	var li = $('#output ul').children().get(img_on_page);
	var f = $(li).data('path');
	$("#overlay_img").attr('src',"?cmd=get&path=" + f);
}, this, "#myModal");

jwerty.key('shift+←', function () { 
	page--;
	searchFoto();
}, this, "body");

var tst = {"code":"info","msg":"Welcome to Foto Workflow. Nice to see you."};
_note(tst.code, tst.msg);

Zepto(function($){ // - page ready
	page = 1;
	searchFoto();
	_readImportPattern();
});
</script>

</body>
</html>