<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Foto Selector</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/bootstrap-responsive.min.css" rel="stylesheet">
<link href="css/bootstrap-lightbox.min.css" rel="stylesheet">

<script src="js/zepto.min.js"></script>
<script src="js/data.js"></script>
<script src="js/selector.js"></script>
<script>
window.jQuery = Zepto;
</script>
<script src="js/jsOAuth.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jwerty.js"></script>
<script src="js/bootstrap-lightbox.min.js"></script>

<style type="text/css">
.r90
{
    -moz-transform:rotate(90deg);
    -webkit-transform:rotate(90deg);
}
.r180
{
    -moz-transform:rotate(180deg);
    -webkit-transform:rotate(180deg);
}
.r270
{
    -moz-transform:rotate(270deg);
    -webkit-transform:rotate(270deg);
}
</style>

</head>
<body>

<div>
  <input id="query" type="text" class="input-xlarge search-query">
      <a id="Prev1" class="btn" href="#"><i class="icon-step-backward"></i></a>
      <a id="Prev" class="btn" href="#"><i class="icon-circle-arrow-left"></i></a>
      <a id="Next" class="btn" href="#"><i class="icon-circle-arrow-right"></i></a>
  <a id='doc-all' class='btn' href="#"><i class='icon-thumbs-down' title='mark all as documentary'></i></a>
  
<div class="btn-group">
  <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
    <i class='icon-wrench'></i>
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu">
    <li><a href="?cmd=evernote-oauth"><i class="icon-ok-circle"></i> Authorize with Evernote</a></li>
    <li><a id="menuImport" href="#"> Import more Photos</a></li>
    <li><a id="ping" href="#"> Ping</a></li>
  </ul>
</div>
<div id="msgbox">
</div>

<div id="modalImport" class="modal hide fade">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>Import more photos</h3>
  </div>
  <div class="modal-body">
<form class="form-horizontal">
  <div class="control-group">
    <label class="control-label" for="importPath">Path</label>
    <div class="controls">
      <input type="text" id="importPath" class="input-xlarge" placeholder="Where to import your photos from (path)">
    </div>
  </div>
  <div class="control-group">
    <label class="control-label" for="importPattern">Foto Naming Pattern</label>
    <div class="controls">
      <input type="text" id="importPattern" class="input-xlarge" placeholder="/@{CreationDate: yyyy}/@{Model}/@{CreationDate: yyyy-MM}/@{CreationDate: yyyy-MM-dd'T'HHmm}_@{Filename}@{Unique}.@{Extension}">
    </div>
  </div>
</form>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn">Close</a>
    <a id="importStart" href="#" class="btn btn-primary">Start import</a>
  </div>
</div>

<div id="myModal" class="lightbox hide fade"  tabindex="-1" role="dialog" aria-hidden="true" width="600px">
	<div class='lightbox-header'>
		<button type="button" class="close" data-dismiss="lightbox" aria-hidden="true">&times;</button>
	</div>
	<div class='lightbox-content'>
	  <img id="overlay_img" />
	</div>
</div>


<div id="output" />


<script>

var page = 1;
var img_on_page = 0;

var _note = function(code, text) {
	// console.log("_note: " + code + " " + text);
	var style = 'alert-success';
	if( "info" == code) {
		style = 'alert-info';
	}
	if( "error" == code) {
		style = 'alert-error';
	}
	$('#msgbox').html('<div class="alert ' + style + '"><a class="close" data-dismiss="alert">&times;</a><span>'+text+'</span></div>');
}

var _rotate = function rotate(el, ang, parent) {
	var w = el.attr("width");
	el.animate({rotateZ:ang, translate3d: '0,10px,0'},200,'ease-out');
	parent.attr("height",w + 20);
}

var _save = function(path, k, v) {
	var url = "/?cmd=store&path=" + path + "&k=" + k + "&v="+v;
	$.get(url, function(response){
		_note("info", "saved " + v + " for " + path);
	});
}

var _readImportPattern = function() {
	var url = "/?cmd=cfg.get&k=importPattern";
	$.getJSON(url, function(r){
		$("#importPattern").val(r.payload.importPattern);
	});
}
var _setRotation = function setRotation(path, angle, img) {
	_save(path, "orientation", angle);
	var url = "/?cmd=invalidate_thumbnail&path=" + path;
	$.ajax({
		  type: 'GET',
		  url: url,
		  async: false,
		  success: function(response){
			  _note("info", "thumbnail invalidated for " + path);
			  // console.log("save result: " + response);
		  },
	});	
	var now = new Date().getTime();
	url = "/?cmd=thumbnail&t=" + now + "&path=" + path;
	img.attr("src",url);
}

var _qualificationButton = function(item, iconName, category) {
	var bDoc = $("<a class='btn btn-mini' href='#'></a>");
	var icn = $("<i class='" + iconName + "' title='" + category + "'></i>");
	bDoc.append(icn);
	if( category == item.category) {
		bDoc.addClass("btn-inverse");
		icn.addClass("icon-white");
	}
	bDoc.on('click', function(e) {
		_save(item.path,"category", category);
		bDoc.addClass("btn-inverse");
		icn.addClass("icon-white");
	});
	return bDoc;
}

var _evernote_link = function(item) {
	var bDoc = $("<a class='btn btn btn-mini' href='#'></a>");
	var icn = $("<i class='icon-magnet' title='Evernote Sync'></i>");
	bDoc.append(icn);
	if( undefined != item.noteId && item.noteId.length > 1) {
		bDoc.addClass("btn-inverse");
		icn.addClass("icon-white");
	}
	bDoc.on('click', function(e) {
		var url = "/?cmd=evernote-link&path=" + item.path;
		$.getJSON(url, function(response){
			// console.log("evernote-link result: %o", response);
			_note(response.code, response.msg);
		});
		bDoc.addClass("btn-inverse");
		icn.addClass("icon-white");
	});
	return bDoc;
}

var searchFoto = function searchFoto() {
	var url = "/?cmd=list&st=" + $('#query').val() + "&p="+page;
	$.getJSON(url,function(data){
		var twitterList = $( "<ul class='thumbnails'/>" );
		$( "#output" ).empty();
		if( "ok" != data.code) {
			_note(data.code, data.msg);
		}
		$.each( data.payload, function( index, item ) {
			var tr = $( "<li class='span4'/>" );
			tr.data('path',item.path);

			var td = $("<div class='thumbnail' />");
			tr.append(td);
			
			var href = $("<a href='#'></a>");
			href.data('path',item.path);
			href.bind('click', function () {
			    var t = $(this); // get the current value of the input field.
			    var src = t.data('path');
			    var oi = $("#overlay_img"); 
				oi.attr('src',"?cmd=get&path=" + src);
			    var bx = $("#myModal"); 
				bx.removeClass("r90");
				bx.removeClass("r180");
				bx.removeClass("r270");
				if( item.orientation.indexOf("90 CW") != -1) {
					bx.addClass("r90");
				}
				if( item.orientation.indexOf("270 CW") != -1) {
					bx.addClass("r270");
				}
				if( item.orientation.indexOf("180") != -1) {
					bx.addClass("r180");
				}
			    $("#myModal").lightbox();
			});
			td.append(href);

			var img = $("<img src='" + item.thumbnail + "'>");
			href.append(img);

			var ip = $("<input />", { type:"text" })
			if (typeof(item.note) != "undefined" && item.note.length > 0) {
				ip.val(item.note);
			}
			ip.bind('change', function() { 
			    var f = $(this) // get the current value of the input field.
			    var tr = f.closest("li");
				_save(tr.data("path"), "note", f.val());
			});
			td.append(ip);

			var commands = $("<p />");
			td.append(commands);
			
			var b090 = $("<button class='btn btn-info btn-mini' type='button'>R</button>");
			b090.on('click', function(e) {
				_setRotation(item.path, "90 CW", img);
			});
			commands.append(b090);
			
			var b270 = $("<button class='btn btn-info btn-mini' type='button'>L</button>");
			b270.on('click', function(e) {
			    var f = $(this) // get the current value of the input field.
			    var tr = f.closest("li");
			    var path = tr.data("path");
				_setRotation(path, "270 CW", img);
			});
			commands.append(b270);
			
			var bNone = $("<button class='btn btn-info btn-mini' type='button'>NR</button>");
			bNone.on('click', function(e) {
				_rotate(img,"0deg", img);
				_save(item.path,"orientation", "rotation reset");
			});
			commands.append(bNone);
			
			// -- qualifications --
			
			var bDoc = _qualificationButton(item, 'icon-thumbs-down', 'documentary');
			commands.append(bDoc);
			
			var bDoc = _qualificationButton(item, 'icon-star-empty', 'normal');
			commands.append(bDoc);

			var bDoc = _qualificationButton(item, 'icon-thumbs-up', 'selection');
			commands.append(bDoc);

			var bDoc = _qualificationButton(item, 'icon-star', 'best-of');
			commands.append(bDoc);
			
			// evernote
			var bDoc = _evernote_link(item);
			commands.append(bDoc);

			twitterList.append(tr);
		});
		$( "#output" ).append( twitterList );
	});
}

var elem = $('#search');
elem.on('click', function(e) {
	page = 1;
	searchFoto();
});

var elem = $('#query');
elem.bind('change', function() { 
	page = 1;
	searchFoto();
});

var elem = $('#Next');
elem.on('click', function(e) {
	page++;
	searchFoto();
});

var elem = $('#Prev');
elem.on('click', function(e) {
	page--;
	searchFoto();
});

var elem = $('#Page1');
elem.on('click', function(e) {
	page = 1;
	searchFoto();
});

var elem = $('#Page10');
elem.on('click', function(e) {
	page = 10;
	searchFoto();
});

var elem = $('#Page20');
elem.on('click', function(e) {
	page = 20;
	searchFoto();
});

var elem = $('#doc-all');
elem.on('click', function(e) {
  $('#output ul li').each(function(index) {
	  var v = $(this);
	  var f = v.data('path');
	  _save(f,"category", "documentary");
  });  
});

$('#ping').on('click', function(e) {
	var url = "/?cmd=ping"
	$.getJSON(url, function(r){
		_note(r.code, r.msg);
	});
});

$('#menuImport').on('click', function(e) {
	$('#modalImport').modal();
});

$('#importStart').on('click', function(e) {
	var url = "/?cmd=import&path=" + $('#importPath').val() + "&pattern=" + $('#importPattern').val();
	$.getJSON(url, function(r){
		_note(r.code, r.msg);
		});
});


jwerty.key('shift+→', function () { 
	page++;
	searchFoto();
}, this, "body");

jwerty.key('shift+ctrl+→', function () {
	img_on_page++;
	if( img_on_page > 5) {
		img_on_page = 0;
	}
	var li = $('#output ul').children().get(img_on_page);
	var f = $(li).data('path');
	$("#overlay_img").attr('src',"?cmd=get&path=" + f);
}, this, "#myModal");

jwerty.key('shift+←', function () { 
	page--;
	searchFoto();
}, this, "body");

var tst = {"code":"info","msg":"Welcome to Foto Workflow. Nice to see you."};
_note(tst.code, tst.msg);

Zepto(function($){ // - page ready
	page = 1;
	searchFoto();
	_readImportPattern();
});
</script>

</body>
</html>